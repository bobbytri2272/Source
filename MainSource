-- Hàm giải mã Base64
function base64_decode(data)
    local b = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    data = string.gsub(data, '[^'..b..'=]', '')
    return (data:gsub('.', function(x)
        if (x == '=') then return '' end
        local r, f = '', (b:find(x)-1)
        for i = 6, 1, -1 do r = r .. (f % 2^i - f % 2^(i-1) > 0 and '1' or '0') end
        return r
    end):gsub('%d%d%d?%d?%d?%d?%d?%d?', function(x)
        if (#x ~= 8) then return '' end
        local c = 0
        for i = 1, 8 do c = c + (x:sub(i,i) == '1' and 2^(8-i) or 0) end
        return string.char(c)
    end))
end

-- Hàm chuyển đổi ngày thành timestamp
function date_to_timestamp(date_str)
    local pattern = "(%d+)-(%d+)-(%d+)_(%d+)-(%d+)-(%d+)"
    local year, month, day, hour, min, sec = date_str:match(pattern)
    return os.time({
        year = tonumber(year),
        month = tonumber(month),
        day = tonumber(day),
        hour = tonumber(hour),
        min = tonumber(min),
        sec = tonumber(sec)
    })
end

-- Hàm kiểm tra thời gian hợp lệ (không quá 1 ngày)
function check_date_valid(saved_date_str)
    local current_timestamp = os.time()
    local saved_timestamp = date_to_timestamp(saved_date_str)
    local diff_seconds = os.difftime(current_timestamp, saved_timestamp)
    local diff_days = diff_seconds / (24 * 60 * 60)
    
    return diff_days <= 1, diff_days
end

function read_and_verify()
    -- Đọc file key.txt
    local path = "/storage/emulated/0/Pictures/key.txt"
    local file = io.open(path, "r")
    if not file then
        gg.alert("Không tìm thấy file key.txt!")
        return false
    end
    
    local encrypted = file:read("*a")
    file:close()
    
    if not encrypted or encrypted == "" then
        gg.alert("File key.txt trống!")
        return false
    end
    
    -- Giải mã và tách thông tin
    local decoded = base64_decode(encrypted)
    local date_str, hwid = decoded:match("^(.*)|(.*)$")
    
    if not date_str or not hwid then
        gg.alert("Định dạng HWID không hợp lệ!")
        return false
    end
    
    -- Kiểm tra thời gian
    local is_valid, diff_days = check_date_valid(date_str)
    
    if not is_valid then
        gg.alert(string.format("HWID đã hết hạn (quá %.2f ngày)", diff_days))
        return false
    end
    
    gg.alert(string.format("HWID hợp lệ!\nNgày: %s\nHWID: %s\nCòn hiệu lực: %.2f ngày", 
           date_str, hwid, 1 - diff_days))
    return true
end

-- Chạy kiểm tra
if gg then
    read_and_verify()
else
    print("Yêu cầu môi trường GameGuardian")
end
